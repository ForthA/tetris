<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tetris</title>
</head>
<body onload = "load_player_name(); loop();">
<script>
    var board = [];

    // заполняем сразу массив пустыми ячейками
    for (let row = -2; row < 20; row++) {
        board[row] = [];

        for (let col = 0; col < 10; col++) {
            board[row][col] = 0;
        }
    }

    var new_figure_board = []

    var figures_name = ['S', 'B', 'L', 'Z', 'T'];

    const figures = {
        'S' : [[1, 1, 1, 1],
               [0, 0, 0, 0],
               [0, 0, 0, 0],
               [0, 0, 0, 0]],
        'B' : [[1, 1],
               [1, 1]],
        'L' : [[1, 0, 0],
               [1, 0, 0],
               [1, 1, 0]],
        'Z' : [[1, 0, 0],
               [1, 1, 0],
               [0, 1, 0]],
        'T' : [[1, 1, 1],
               [0, 1, 0]]
    }
    const colors = {
        'S': "blue",
        'B': "red",
        'L': "orange",
        'Z': "green",
        'T': "purple"
    }

    document.addEventListener('keydown', (event) => {
    })
    function draw_board(){
        const canvas = document.getElementById("tetris_board");
        if (canvas.getContext('2d')){
            let ctx = canvas.getContext('2d');
            for (let i = 0;i < board.length;i++){
                for(let j = 0;j < board[i].length;j++){
                    if (board[i][j] !== 0) {
                        ctx.fillStyle = colors[board[i][j]];
                        ctx.fillRect((i * 35) + 1, (j * 35) + 1, 34, 34);
                    }
                }
            }
        }
    }
    function rotate_matrix(arr){
        let n_arr= []; // новый перевёрнутый массив

        let n_rows = arr[0].length;   // количество новых строк

        let n_cols = arr.length;      // количество новых столбцов

        for(let x = 0; x < n_rows; x++){

            let row_arr = []; // это элемент из нового массива

            for(let y = (n_cols - 1), z = 0; y >= 0; y--, z++){

                row_arr[z] = arr[y][x];

            }

            n_arr[x] = row_arr;

        };

        return n_arr;
    }

    function draw_new_figure_window(name, color){
        const canvas = document.getElementById("new_tetris_figure");
        new_figure_board = rotate_matrix(new_figure_board);
        if (canvas.getContext('2d')){
            let ctx = canvas.getContext('2d');
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.height, canvas.width);
            for (let i = 0;i < new_figure_board.length;i++){
                for(let j = 0;j < new_figure_board[i].length;j++){
                    if (new_figure_board[i][j] !== 0) {
                        ctx.fillStyle = color;
                        if (name === 'S')
                            ctx.fillRect(52.5 * i + 1,52.5 * j + 1 - 70, 51.5, 51.5)
                        else
                            ctx.fillRect(31 + 52.5 * i + 1, 31 + 52.5 * j + 1, 51.5, 51.5);
                    }
                }
            }

        }
    }
    function get_new_figure() {
        let figure_number = Math.floor(Math.random() * 5);
        let name = figures_name[figure_number];
        let color = colors[name]
        let matrix = figures[name];
        new_figure_board = matrix;
        draw_new_figure_window(name, color);
        return {
            name: name,
            matrix: matrix,
            row : 4,
            column : 4
        };
    }
    function place_figure(figure){
        for (let i = 0; i < figure.matrix.length; i++){
            for(let j = 0; j < figure.matrix[i].length; j++){
                board[figure.row + i][figure.column + j] = figure.name;
            }
        }
    }
    function loop(){
        const canvas = document.getElementById("tetris_board");
        const ctx = canvas.getContext('2d');
        var time = 0;
        while (true){
            if (time === 0)
                var figure = get_new_figure();
            draw_board();
            for (let i = 0; i < figure.matrix.length; i++){
                for(let j = 0; j < figure.matrix[i].length; j++){
                    ctx.fillStyle = colors[figure.name];
                    if (figure.matrix[i][j] === 1)
                        ctx.fillRect(((i + figure.row) * 35) + 1, ((j + figure.column) * 35) + 1, 34, 34);
                }
            }
            time++;
        }
    }
    function read(source){
        source.value = localStorage["tetris.username"];
    }
    function load_player_name(){
        let source = {};
        read(source);
        let name_place = document.getElementById("name-place");
        name_place.innerHTML = "Игрок: " + source.value;
    }
</script>

<p id="name-place"></p>
<canvas height='250' width='250' id='new_tetris_figure' style = "border:2px solid black"></canvas>
<canvas height='600' width='300' id='tetris_board'  style = "border:2px solid black"></canvas>
<script>
</script>
</body>
</html>